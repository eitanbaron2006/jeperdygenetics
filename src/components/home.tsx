import React, { useState } from "react";
import GameBoard from "./game/GameBoard";
import ScoreBoard from "./game/ScoreBoard";
import HostPanel from "./game/HostPanel";
import QuestionModal from "./game/QuestionModal";

interface Team {
  id: string;
  name: string;
  score: number;
  isActive: boolean;
}

const Home = () => {
  const [teams, setTeams] = useState<Team[]>([
    { id: "1", name: "קבוצה אלפא", score: 1000, isActive: true },
    { id: "2", name: "קבוצה בטא", score: 800, isActive: false },
    { id: "3", name: "קבוצה גמא", score: 600, isActive: false },
  ]);

  const [isQuestionModalOpen, setIsQuestionModalOpen] = useState(false);
  const [currentQuestion, setCurrentQuestion] = useState({
    category: "",
    points: 0,
    question: "",
    answer: "",
  });

  const questions = {
    "מבנה DNA": {
      200: {
        question: "הסבר את המבנה הבסיסי של DNA ומה תפקיד הקשרים המימניים בו",
        answer:
          "ה-DNA בנוי משני גדילים המחוברים בקשרי מימן בין בסיסים חנקניים משלימים: A-T ו-G-C. קשרים אלו מייצבים את המבנה הסלילי הכפול ומאפשרים את פתיחת הסליל בזמן שכפול ותעתוק",
      },
      400: {
        question: "תאר את תהליך השכפול של DNA והאנזימים המעורבים בו",
        answer:
          "תהליך השכפול כולל: 1) פתיחת סליל על ידי הליקאז 2) סינתזת גדיל חדש על ידי DNA פולימראז 3) חיבור קטעי אוקזאקי על ידי DNA ליגאז. התהליך הוא חצי-שמרני ומדויק מאוד",
      },
      600: {
        question: "הסבר את מנגנון התיקון של DNA ומדוע הוא חשוב",
        answer:
          "מנגנוני תיקון DNA כוללים: 1) תיקון שגיאות התאמה (mismatch repair) 2) תיקון נזקי UV על ידי אנזימי NER 3) תיקון שברים דו-גדיליים. חשיבותם במניעת מוטציות ושמירה על יציבות הגנום",
      },
      800: {
        question: "הסבר את תהליך התעתוק (transcription) ואת השלבים העיקריים בו",
        answer:
          "תהליך התעתוק כולל: 1) התחלה - זיהוי פרומוטור והיצמדות RNA פולימראז 2) התארכות - סינתזת RNA משלים 3) סיום - זיהוי רצף סיום והתנתקות. כולל גם עיבוד ה-RNA לאחר התעתוק",
      },
      1000: {
        question:
          "הסבר את הקשר בין מבנה הכרומטין לפעילות הגנים ואת מנגנוני בקרת הביטוי",
        answer:
          "מבנה הכרומטין משפיע על נגישות גורמי תעתוק: 1) אזורים פתוחים (אוכרומטין) מאפשרים תעתוק 2) אזורים סגורים (הטרוכרומטין) מדכאים תעתוק. שינויים אפיגנטיים כמו מתילציה והיסטון מודיפיקציות מווסתים את המבנה",
      },
    },
    תורשה: {
      200: {
        question: "הסבר את חוקי מנדל והדגם כיצד הם באים לידי ביטוי בהכלאות",
        answer:
          "חוקי מנדל כוללים: 1) חוק ההפרדה - הפרדת אללים בגמטות 2) חוק הסגרגציה העצמאית - תכונות נפרדות עוברות באופן עצמאי. בהכלאה F1 מתקבל יחס של 3:1 בתכונה דומיננטית",
      },
      400: {
        question: "הסבר את התופעה של תאחיזה מינית ואת השפעתה על דפוסי תורשה",
        answer:
          "תאחיזה מינית מתרחשת כאשר גן נמצא על כרומוזום X. בזכרים (XY) הגן מתבטא תמיד, בעוד בנקבות (XX) יש שני עותקים. דוגמאות: עיוורון צבעים, המופיליה",
      },
      600: {
        question: "הסבר את המושג פנטרציה משתנה והדגם מקרים בהם זה מתרחש",
        answer:
          "פנטרציה משתנה מתארת מצב בו אותו גנוטיפ יכול להתבטא בעוצמות שונות או לא להתבטא כלל. דוגמאות: 1) סרטן שד תורשתי BRCA 2) מחלת הנטינגטון. גורמים סביבתיים ומודיפיקטורים גנטיים משפיעים על הביטוי",
      },
      800: {
        question: "הסבר את התופעה של אפיסטזיס והשפעתה על היחסים המנדליאניים",
        answer:
          "אפיסטזיס היא אינטראקציה בין גנים שונים המשפיעה על הפנוטיפ. לדוגמה: 1) גן אחד מסכל את פעולת גן אחר 2) שני גנים נדרשים יחד לביטוי תכונה. משנה את היחסים הקלאסיים של מנדל ל-9:7, 12:3:1 וכדומה",
      },
      1000: {
        question: "הסבר את המושג פלאוטרופיה והשלכותיו הקליניות",
        answer:
          "פלאוטרופיה היא השפעה של גן אחד על מספר תכונות שונות. דוגמה: תסמונת מארפן - מוטציה בגן פיברילין משפיעה על מערכות שונות: שלד, עיניים, לב. חשוב להבנת מחלות גנטיות מורכבות ואבחונן",
      },
    },
    מוטציות: {
      200: {
        question: "מהם הסוגים העיקריים של מוטציות נקודתיות?",
        answer:
          "מוטציות נקודתיות כוללות: 1) החלפת בסיס (missense/nonsense) 2) הוספה/חסר של בסיס (frameshift) 3) מוטציות באתרי splicing. השפעתן תלויה במיקום ובסוג השינוי",
      },
      400: {
        question:
          "הסבר את ההבדל בין מוטציות סומטיות למוטציות בתאי הנבט והשלכותיהן",
        answer:
          "מוטציות סומטיות מתרחשות בתאי גוף ולא עוברות בתורשה, קשורות בעיקר להתפתחות סרטן. מוטציות בתאי נבט עוברות לצאצאים ומשפיעות על כל תאי הגוף, גורמות למחלות תורשתיות",
      },
      600: {
        question: "הסבר את הקשר בין מוטציות לאבולוציה ואת מנגנוני הסלקציה",
        answer:
          "מוטציות הן מקור השונות הגנטית באבולוציה. סלקציה טבעית פועלת על שונות זו: 1) סלקציה חיובית מעדיפה מוטציות מועילות 2) סלקציה שלילית מסלקת מוטציות מזיקות 3) סלקציה מאזנת שומרת על פולימורפיזם",
      },
      800: {
        question: "הסבר את המושג 'נטל מוטציות' והשלכותיו על אוכלוסיות",
        answer:
          "נטל מוטציות הוא הצטברות מוטציות מזיקות באוכלוסייה. השפעות: 1) ירידה בכשירות האוכלוסייה 2) חשיבות הרבייה המינית בסילוק מוטציות 3) השפעה על גודל אוכלוסייה אפקטיבי. חשוב במיוחד באוכלוסיות קטנות ומבודדות",
      },
      1000: {
        question:
          "הסבר את הקשר בין מוטציות אפיגנטיות לסרטן ואת המנגנונים המולקולריים",
        answer:
          "מוטציות אפיגנטיות משנות דפוסי ביטוי גנים ללא שינוי ברצף DNA: 1) היפרמתילציה של גני מדכאי סרטן 2) היפומתילציה גלובלית המובילה לחוסר יציבות גנומית 3) שינויים בהיסטונים המשפיעים על מבנה הכרומטין",
      },
    },
    "ביולוגיה של התא": {
      200: {
        question: "הסבר את מבנה ותפקוד הממברנה התאית",
        answer:
          "הממברנה התאית מורכבת משכבה כפולה של פוספוליפידים וחלבונים. תפקידים: 1) בררנות במעבר חומרים 2) קליטת אותות 3) תקשורת בין-תאית. חלבוני הממברנה מאפשרים העברה סלקטיבית של מולקולות",
      },
      400: {
        question: "תאר את תהליך הנשימה התאית ותפקיד המיטוכונדריה",
        answer:
          "נשימה תאית כוללת: 1) גליקוליזה בציטופלסמה 2) מעגל קרבס במטריקס המיטוכונדריה 3) שרשרת העברת אלקטרונים בממברנה הפנימית. המיטוכונדריה מייצרת ATP דרך זרחון חמצוני",
      },
      600: {
        question: "הסבר את מנגנוני בקרת מחזור התא ונקודות הבקרה",
        answer:
          "בקרת מחזור התא כוללת: 1) נקודות בקרה ב-G1, G2, M 2) מערכת ציקלינים ו-CDKs 3) בקרת תיקון DNA. כשל בבקרה מוביל להתפתחות סרטן. חלבון p53 מרכזי בתגובה לנזקי DNA",
      },
      800: {
        question: "הסבר את תהליך האוטופגיה ותפקידו בתא",
        answer:
          "אוטופגיה היא תהליך פירוק רכיבי תא פגומים: 1) יצירת אוטופגוסום 2) היתוך עם ליזוזום 3) פירוק ומיחזור. חשוב להסרת אברונים פגומים, הגנה מפני פתוגנים, והסתגלות לרעב",
      },
      1000: {
        question: "הסבר את מנגנוני התקשורת הבין-תאית ומסלולי העברת האותות",
        answer:
          "תקשורת בין-תאית כוללת: 1) קולטנים ממברנליים המזהים ליגנדים 2) מסלולי העברת אותות דרך חלבוני G ואנזימי קינאז 3) פקטורי תעתוק המשנים ביטוי גנים. חשוב להתפתחות, דיפרנציאציה ותגובה להורמונים",
      },
    },
    אבולוציה: {
      200: {
        question: "הסבר את עקרונות הברירה הטבעית של דרווין",
        answer:
          "עקרונות הברירה הטבעית: 1) שונות בין פרטים 2) תכונות עוברות בתורשה 3) תחרות על משאבים 4) הישרדות והתרבות דיפרנציאלית של הפרטים המותאמים ביותר",
      },
      400: {
        question: "הסבר את משמעות שיווי המשקל הרדי-ויינברג ומתי הוא מופר",
        answer:
          "חוק הרדי-ויינברג מתאר יציבות תדירויות אללים באוכלוסייה. מופר על ידי: 1) מוטציות 2) סלקציה 3) זרימת גנים 4) רבייה לא אקראית 5) אפקט המייסד. משמש כנקודת ייחוס לזיהוי אבולוציה",
      },
      600: {
        question: "הסבר את תופעת הסחיפה הגנטית והשפעתה על אוכלוסיות קטנות",
        answer:
          "סחיפה גנטית היא שינוי אקראי בתדירויות אללים. השפעות: 1) אובדן שונות גנטית 2) קיבוע אללים אקראי 3) אפקט צוואר הבקבוק באוכלוסיות קטנות. משמעותי יותר באוכלוסיות קטנות ומבודדות",
      },
      800: {
        question: "הסבר את תהליך הספציאציה ומנגנוני בידוד רבייתי",
        answer:
          "ספציאציה היא היווצרות מינים חדשים דרך: 1) בידוד גיאוגרפי 2) בידוד רבייתי - התנהגותי, מכני, גמטי 3) הצטברות שינויים גנטיים. דוגמאות: עגורי גלפגוס, זבובי הוואי",
      },
      1000: {
        question: "הסבר את תיאוריית האבולוציה הניטרלית ומשמעותה",
        answer:
          "תיאוריית האבולוציה הניטרלית גורסת: 1) רוב המוטציות ניטרליות מבחינת סלקציה 2) שינויים מולקולריים מתרחשים בקצב קבוע 3) סחיפה גנטית משמעותית יותר מסלקציה ברמה המולקולרית. משמשת בסיס לשעון המולקולרי",
      },
    },
  };

  const handleCardSelect = (category: string, points: number) => {
    const questionData = questions[category]?.[points] || {
      question: "שאלה לא נמצאה",
      answer: "תשובה לא נמצאה",
    };
    setCurrentQuestion({
      category,
      points,
      question: questionData.question,
      answer: questionData.answer,
    });
    setIsQuestionModalOpen(true);
  };

  const handleCorrectAnswer = () => {
    setTeams((prevTeams) =>
      prevTeams.map((team) =>
        team.isActive
          ? { ...team, score: team.score + currentQuestion.points }
          : team,
      ),
    );
    setIsQuestionModalOpen(false);
    advanceToNextTeam();
  };

  const handleIncorrectAnswer = () => {
    setIsQuestionModalOpen(false);
    advanceToNextTeam();
  };

  const advanceToNextTeam = () => {
    setTeams((prevTeams) => {
      const activeIndex = prevTeams.findIndex((team) => team.isActive);
      const nextIndex = (activeIndex + 1) % prevTeams.length;
      return prevTeams.map((team, index) => ({
        ...team,
        isActive: index === nextIndex,
      }));
    });
  };

  const handleScoreAdjust = (teamId: string, amount: number) => {
    setTeams((prevTeams) =>
      prevTeams.map((team) =>
        team.id === teamId ? { ...team, score: team.score + amount } : team,
      ),
    );
  };

  return (
    <div className="min-h-screen bg-slate-950 flex">
      {/* Main Game Area */}
      <div className="flex-1 p-8 flex flex-col items-center justify-start pt-16">
        <GameBoard
          onCardSelect={handleCardSelect}
          className="justify-center items-center grow h-screen min-h-screen min-h-[1300] h-[1300] h-[1500] min-h-[1500]"
        />
      </div>
      {/* Scoreboard */}
      <div className="w-[300px] border-l border-slate-800">
        <ScoreBoard teams={teams} />
      </div>
      {/* Host Panel */}
      <HostPanel teams={teams} onScoreAdjust={handleScoreAdjust} />
      {/* Question Modal */}
      <QuestionModal
        isOpen={isQuestionModalOpen}
        onClose={() => setIsQuestionModalOpen(false)}
        category={currentQuestion.category}
        points={currentQuestion.points}
        question={currentQuestion.question}
        answer={currentQuestion.answer}
        onCorrect={handleCorrectAnswer}
        onIncorrect={handleIncorrectAnswer}
      />
    </div>
  );
};

export default Home;
